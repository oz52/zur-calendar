<!DOCTYPE html>
<html><head>
  <title>Zur Calendar</title>
  <link rel="manifest" href="/manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js');
    }
  </script>
</head><body>
  <div class="family-member">Ofri</div>
  <div class="family-member">Mom</div>
  <div class="family-member">Dad</div>
  <button class="add-appointment">Add Appointment</button>

  <form id="newAppointmentForm" class="hidden">
    <input id="familyMember" name="familyMember" required />
    <input id="meetingWith" name="meetingWith" />
    <input id="location" name="location" />
    <input id="date" name="date" type="date" required />
    <input id="time" name="time" type="time" required />
    <input id="duration" name="duration" />
    <textarea id="notes" name="notes"></textarea>
    <button type="submit">Submit</button>
  </form>

  <div id="conflictAlert" class="hidden">Conflict!</div>
  <div id="successMessage" class="hidden">Saved!</div>

  <div id="overviewCalendar">
    <div class="calendar-day" data-date="2025-08-01"></div>
    <div class="calendar-day" data-date="2025-08-02"></div>
    <div class="calendar-day" data-date="2025-08-03"></div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("newAppointmentForm");
  const calendar = document.getElementById("overviewCalendar");
  const alertBox = document.getElementById("conflictAlert");
  const successBox = document.getElementById("successMessage");

  let selectedFamilyMember = null;

  document.querySelectorAll(".family-member").forEach(member => {
    member.addEventListener("click", () => {
      selectedFamilyMember = member.textContent.trim();
      document.getElementById("familyMember").value = selectedFamilyMember;
      form.classList.remove("hidden");
    });
  });

  document.querySelector(".add-appointment")?.addEventListener("click", () => {
    form.classList.toggle("hidden");
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    alertBox.classList.add("hidden");
    successBox.classList.add("hidden");

    const data = {
      familyMember: form.familyMember.value,
      meetingWith: form.meetingWith.value,
      location: form.location.value,
      date: form.date.value,
      time: form.time.value,
      duration: form.duration.value,
      notes: form.notes.value
    };

    const existing = await fetch("/appointments").then(res => res.json());
    const conflict = existing.find(ev => ev.date === data.date && ev.time === data.time && ev.familyMember === data.familyMember);
    if (conflict) {
      alertBox.classList.remove("hidden");
      return;
    }

    await fetch("/appointments", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    form.reset();
    successBox.classList.remove("hidden");
    loadAppointments();
  });

  async function loadAppointments() {
    const res = await fetch("/appointments");
    const list = await res.json();
    calendar.querySelectorAll(".calendar-day").forEach(day => {
      const date = day.dataset.date;
      const daily = list.filter(ev => ev.date === date);
      day.innerHTML = `<div class='date-label'>${date.slice(-2)}</div>` + daily.map(ev => `
        <div class='appt-pill ${ev.familyMember.toLowerCase()}'>
          ${ev.time} ${ev.familyMember}
        </div>`).join("");
    });
  }

  loadAppointments();
});
</script>
</body></html>
